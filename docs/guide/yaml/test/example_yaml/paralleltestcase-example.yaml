brooklyn.catalog:
  id: parallel-test
  version: 1.0
  itemType: template
  iconUrl: http://tomcat.apache.org/images/tomcat.png
  name: Parallel Tomcat and DB Example Test
  license: Apache-2.0
  item:
    brooklyn.config:
      simple.confg: someValue
    services:
    - type: org.apache.brooklyn.test.framework.TestCase
      name: Parallel Testcase
      brooklyn.children:
      - type: org.apache.brooklyn.test.framework.TestCase
        name: Parallel Testcase
        brooklyn.children:
        - type: org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster
          name: My Web
          id: webappcluster
          brooklyn.config:
            wars.root: http://search.maven.org/remotecontent?filepath=io/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.6.0/brooklyn-example-hello-world-sql-webapp-0.6.0.war
            java.sysprops:
              brooklyn.example.db.url: >
                $brooklyn:formatString("jdbc:%s%s?user=%s&password=%s",
                component("db").attributeWhenReady("datastore.url"),
                "visitors", "brooklyn", "br00k11n")
        - type: org.apache.brooklyn.entity.database.mysql.MySqlNode
          id: db
          name: My DB
          brooklyn.config:
            creationScriptUrl: https://bit.ly/brooklyn-visitors-creation-script
      - type: org.apache.brooklyn.test.framework.TestSensor
        name: Test WebApp Cluster service.isUp
        targetId: webappcluster
        sensor: service.isUp
        timeout: 10m
        assert:
          equals: true
      - type: org.apache.brooklyn.test.framework.TestSensor
        name: Test DB service.isUp
        targetId: db
        sensor: service.isUp
        timeout: 10m
        assert:
          equals: true